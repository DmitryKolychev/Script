Sub CreateMultiLevelFolders()
    Dim ws As Worksheet
    Dim lastRow As Long
    Dim i As Long
    Dim basePath As String
    Dim folderPath As String
    Dim folderName As String
    Dim currentLevel As String
    Dim dict As Object
    
    ' Устанавливаем обработку ошибок
    On Error GoTo ErrorHandler
    
    ' Проверяем существование листа
    Set ws = ThisWorkbook.Sheets("структура")
    
    ' Определяем последнюю строку
    lastRow = ws.Cells(ws.Rows.Count, "A").End(xlUp).Row
    If lastRow < 2 Then
        MsgBox "Нет данных для обработки!", vbInformation
        Exit Sub
    End If
    
    ' Создаем словарь для хранения путей
    Set dict = CreateObject("Scripting.Dictionary")
    
    ' Базовый путь
    basePath = ThisWorkbook.path
    If Right(basePath, 1) <> "\" Then basePath = basePath & "\"
    
    ' Обрабатываем строки
    For i = 2 To lastRow
        currentLevel = Trim(ws.Cells(i, "A").Value)
        If currentLevel = "" Then GoTo NextRow
        
        ' Формируем имя папки
        folderName = currentLevel & " " & Trim(ws.Cells(i, "B").Value)
        
        ' Очищаем имя от недопустимых символов
        folderName = CleanFileName(folderName)
        
        ' Определяем путь для папки
        folderPath = DetermineFolderPath(currentLevel, folderName, basePath, dict)
        
        ' Создаем папку если не существует
        If Not FolderExists(folderPath) Then
            CreateFolder folderPath
        End If
        
        ' Сохраняем путь в словаре
        dict(currentLevel) = folderPath
        
NextRow:
    Next i
    
    MsgBox "Структура папок успешно создана! Обработано " & (lastRow - 1) & " записей.", vbInformation
    Exit Sub
    
ErrorHandler:
    MsgBox "Ошибка: " & Err.Description & vbCrLf & "Строка: " & i, vbCritical
End Sub

Function DetermineFolderPath(level As String, folderName As String, basePath As String, dict As Object) As String
    Dim lastDotPosition As Long
    
    ' Находим позицию последней точки в уровне
    lastDotPosition = InStrRev(level, ".")
    
    ' Если точки нет - это корневой уровень
    If lastDotPosition = 0 Then
        DetermineFolderPath = basePath & folderName
        Exit Function
    End If
    
    ' Извлекаем родительский уровень (все до последней точки)
    Dim parentLevel As String
    parentLevel = Left(level, lastDotPosition - 1)
    
    ' Если родитель найден в словаре
    If dict.Exists(parentLevel) Then
        DetermineFolderPath = dict(parentLevel) & "\" & folderName
    Else
        ' Если родитель не найден, создаем в базовой папке
        DetermineFolderPath = basePath & folderName
    End If
End Function

Function CleanFileName(name As String) As String
    Dim invalidChars As String
    Dim i As Integer
    
    invalidChars = "\/:*?""<>|"
    CleanFileName = name
    
    For i = 1 To Len(invalidChars)
        CleanFileName = Replace(CleanFileName, Mid(invalidChars, i, 1), "_")
    Next i
    
    ' Удаляем лишние пробелы
    CleanFileName = WorksheetFunction.Trim(CleanFileName)
End Function

Function FolderExists(path As String) As Boolean
    FolderExists = (Dir(path, vbDirectory) <> "")
End Function

Sub CreateFolder(path As String)
    On Error Resume Next
    MkDir path
    On Error GoTo 0
End Sub
